class Grapher{constructor(t,i={},s=null,e=null){this.id=t,this.el=document.getElementById(this.id),this.width=s||this.el.offsetWidth,this.height=e||this.el.offsetHeight,this._fontSize=parseFloat(window.getComputedStyle(this.el).fontSize),this.container=d3.select("#"+this.id).append("span").attr("class","grapherContainer"),this.svg=this.container.append("svg").attr("id",this.id+"_svg").attr("class","grapher").attr("width",this.width).attr("height",this.height),null!=i.type&&"sparkline"==i.type?this.isSparkline=!0:this.isSparkline=!1,this._margin={},this.margin={},this._options={data:[],x:{name:"x",scale:"scaleLinear",tickFormat:d3.format(".3s"),parse:null,label:null,domain:null,nice:!1},y:{name:"y",scale:"scaleLinear",tickFormat:d3.format(".3s"),parse:null,label:null,domain:null,nice:!0},category:{name:null,parse:t=>t},categories:!1,type:"line",style:{colors:["#1abb9b","#3497da","#9a59b5","#f0c30f","#e57e22","#e64c3c","#7f8b8c","#CC6666","#9999CC","#66CC99"],barWidth:.8,strokeWidth:3,dotSize:4,grid:!0,tooltipColor:"#181818",tooltipBackgroundColor:"#ffffff",tooltipOpacity:"0.8",tooltipLineColor:"#000000",tooltipFormat:(t,i)=>0===i?this._options.x.tickFormat(t):`${this._options.category.parse(t[this._options.category.name])}: ${this._options.y.tickFormat(t[this._options.y.name])||d3.format(".3s")(t[this._options.y.name])}`},legend:{show:!0,x:15,y:this._margin.top,interstice:25,backgroundColor:"#ffffff",opacity:"0.9"},download:{filename:`data_${this.id}_${Date.now()}.csv`},sparkline:{range:null,textLastPoint:!0,strokeWidth:1,lineColor:"#000000",circleColor:"#f00",textColor:"#f00",textFontSize:"85%",textFontWeight:"600",rangeFillColor:"#ccc"},grid:{x:{show:!1,lines:[]},y:{show:!0,lines:[]}},advanced:{additionalColumnsInData:[]}},this.options=i}get margin(){return this._margin}set margin({top:t=10,right:i=(t=>t<400?20:30),bottom:s,left:e=(t=>t<400?40:60)}={}){this.isSparkline?this._margin={top:0,right:0,bottom:0,left:0}:this._margin={top:t,right:"function"==typeof i?i(this.width):i,bottom:s||2*this._fontSize+20,left:"function"==typeof e?e(this.width):e},this._innerDimensions()}_innerDimensions(){this.innerWidth=this.width-this._margin.left-this._margin.right,this.innerHeight=this.height-this._margin.top-this._margin.bottom,this._createSVG()}_createSVG(){this.svg.select(`#${this.id}_g`).remove(),this.g=this.svg.append("g").attr("id",this.id+"_g").attr("transform",`translate(${this._margin.left},${this._margin.top})`),this._addOverlay()}_addOverlay(){this.g.append("rect").attr("class","overlay").attr("fill","none").attr("style","pointer-events:all;").attr("width",this.innerWidth).attr("height",this.innerHeight)}get options(){return this._options}set options(t){Grapher.updateDict(this._options,t),t.category||this._options.category.name?!this._options.categories&&this._options.category.name?this._options._categories=Grapher.unique(this._options.data.map(t=>t[this._options.category.name])):this._options._categories=this._options.categories:this._options._categories=[this._options.y.label]||[this._options.y.name],t.x&&!t.x.scale&&t.x.parse&&t.x.parse.toString().match(/(d3.timeParse|new Date)/g)&&(this._options.x.scale="scaleTime"),t.y&&!t.y.scale&&t.y.parse&&t.y.parse.toString().match(/(d3.timeParse|new Date)/g)&&(this._options.y.scale="scaleTime"),t.x&&!t.x.tickFormat&&t.x.parse&&t.x.parse.toString().includes("d3.timeParse")&&(this._options.x.tickFormat=d3.timeFormat(Grapher.findTimeFormat(t.x.parse.toString()))),t.y&&!t.y.tickFormat&&t.y.parse&&t.y.parse.toString().includes("d3.timeParse")&&(this._options.y.tickFormat=d3.timeFormat(Grapher.findTimeFormat(t.y.parse.toString()))),this.color=d3.scaleOrdinal().domain(this._options._categories).range(this._options.style.colors),(!this.data||t.data||t.x&&t.x.parse||t.y&&t.y.parse||t.categories)&&this._parseData(),this.margin={left:this._options.y.label?80:60,bottom:this._options.x.label?2*this._fontSize+20:40}}_parseData(){if(this._options.x.parse||this._options.y.parse||this._options.categories.length>0){let t=[],i=this._options.category.name&&this._options.categories.length>0;for(const s of this._options.data)if(!i||this._options.categories.indexOf(s[this._options.category.name])>-1){let i={};i[this._options.x.name]=this._options.x.parse?this._options.x.parse(s[this._options.x.name]):s[this._options.x.name],i[this._options.y.name]=this._options.y.parse?this._options.y.parse(s[this._options.y.name]):s[this._options.y.name],this._options.category.name?i[this._options.category.name]=s[this._options.category.name]:i.category=this._options.y.label||this._options.y.name;for(const t of this._options.advanced.additionalColumnsInData)i[t]=s[t];t.push(i)}this.data=t,this._options.category.name=this._options.category.name||"category"}else this.data=JSON.parse(JSON.stringify(this._options.data))}extent(t,i,s=!1,e=this.data){if("scaleLog"==i){return[d3.min(e.filter(i=>i[t]>0),i=>i[t]),d3.max(e,i=>i[t])]}return s?[Math.min(d3.min(e,i=>i[t]),0),d3.max(e,i=>i[t])]:d3.extent(e,i=>i[t])}static findTimeFormat(t){let i=t.indexOf("d3.timeParse")+14,s=t.slice(i),e=s.indexOf(")")-1;return s.slice(0,e)}static unique(t){if(t.every(t=>t instanceof Date)){let i=(t,i)=>t==i?0:t>i?1:-1;return[...new Set(t.map(t=>t.getTime()))].map(t=>new Date(t)).sort(i)}return t.every(t=>"number"==typeof t)?Array.from(new Set(t)).sort((t,i)=>t-i):Array.from(new Set(t)).sort()}static getOptimalPrecision(t){return`.${Math.abs(Math.floor(Math.log10(t>0?t:1)))+1}%`}static formatTick(t,i){return s=>t?Number.isInteger(Math.log10(s))?d3.format(".3s")(s):null:d3.format(i?Grapher.getOptimalPrecision(s):".3s")(s)}static updateDict(t,i){for(const s of Object.keys(i))Object.keys(t).indexOf(s)>-1&&(null!=i[s]&&i[s].constructor==Object?Grapher.updateDict(t[s],i[s]):t[s]=i[s])}sparkline(){if(this.x=d3.scaleLinear().range([0,this.width-2]).domain(this._options.x.domain?this._options.x.domain:this.extent(this._options.x.name,this._options.x.scale)),this.xValues=Grapher.unique(this.data.map(t=>t[this._options.x.name])),this.y=d3.scaleLinear().range([this.height-4,0]).domain(this._options.y.domain?this._options.y.domain:this.extent(this._options.y.name,this._options.y.scale)),this.svg.selectAll("g.sparkline").remove(),this.container.attr("style","vertical-align:middle; display:inline-block;"),this.g.attr("transform","translate(0,2)").attr("class","sparkline"),this._options.sparkline.range){let t=this.data.map(t=>(t.minRange=this._options.sparkline.range[0],t.maxRange=this._options.sparkline.range[1],t));this.g.append("path").datum(t).attr("fill",this._options.sparkline.rangeFillColor).attr("stroke","none").attr("d",d3.area().x(t=>this.x(t[this._options.x.name])).y0(t=>this.y(t.minRange)).y1(t=>this.y(t.maxRange)))}this.sparkLine=this.g.append("path").datum(this.data).attr("class","sparkLine").attr("fill","none").attr("stroke-width",this._options.sparkline.strokeWidth).attr("stroke",this._options.sparkline.lineColor).attr("d",d3.line().curve(d3.curveBasis).x(t=>this.x(t[this._options.x.name])).y(t=>this.y(t[this._options.y.name]))),this.lastPoint=this.data.slice(-1)[0],this.sparkCircle=this.g.append("circle").attr("class","sparkCircle").attr("cx",this.x(this.lastPoint[this._options.x.name])).attr("cy",this.y(this.lastPoint[this._options.y.name])).attr("r",1.5).attr("fill",this._options.sparkline.circleColor).attr("stroke","none"),this._options.sparkline.textLastPoint&&(this.sparkText=d3.select("#"+this.id).append("span").attr("class","sparkText").text(this._options.y.tickFormat(this.lastPoint[this._options.y.name])).attr("style",`font-size:${this._options.sparkline.textFontSize}; font-weight:${this._options.sparkline.textFontWeight}; color: ${this._options.sparkline.textColor}; margin-bottom:${this.height/2} vertical-align:middle; display:inline-block;`)),this._options.y.label&&(this.sparkText=d3.select("#"+this.id).append("span").attr("class","sparkText").text(this._options.y.label).attr("style",`font-size:${this._options.sparkline.textFontSize}; font-weight:${this._options.sparkline.textFontWeight}; margin-bottom:${this.height/2} vertical-align:middle; display:inline-block; padding-left: 0.4rem;`))}draw(t){t&&(this.options=t),this.g.selectAll("g.x.axis").remove(),this.g.selectAll("g.y.axis").remove(),this.g.selectAll("g.yGrid").remove(),"sparkline"==this._options.type?(this.sparkline(),this.addTooltip()):(this.addX(),"bar"==this._options.type&&this.addX2(),this._options.x.label&&this.addXLabel(),this.addY(),this._options.y.label&&this.addYLabel(),this._options.grid.y.lines.length>0&&this.addYGridLines(),this._options.grid.x.lines.length>0&&this.addXGridLines(),this._draw(),this.addTooltip(),this._options.legend.show&&this.addLegend())}downloadData(){let t=document.createElement("a");t.id="download",t.download=this._options.download.filename,t.href=URL.createObjectURL(new Blob([Grapher.to_csv(this.data)])),t.click()}static to_csv(t,i=!0){let s="";if(t.length>0){let e=Object.keys(t[0]);i&&(s+=e.join(",")+"\n"),s+=t.map((function(t){let i=[];for(const s of e)i.push('"'+t[s]+'"');return i.join(",")})).join("\n")}return s.toString()}addX(){this.xValues=Grapher.unique(this.data.map(t=>t[this._options.x.name])),this.xNbValues=this.xValues.length,this.xWidth=this.innerWidth/this.xNbValues,this.xRange="bar"==this._options.type?[this.xWidth/2,this.innerWidth-this.xWidth/2]:[0,this.innerWidth],this.xNbTicks=d3.min([parseInt((this.width-100)/100),this.xNbValues]),this.x=d3[this._options.x.scale]().domain(this._options.x.domain?this._options.x.domain:this.extent(this._options.x.name,this._options.x.scale)).range(this.xRange),this._options.x.nice&&(this.x=this.x.nice()),this.g.append("g").attr("class","x axis").attr("transform",`translate(0, ${this.innerHeight})`).call(d3.axisBottom(this.x).ticks(this.xNbTicks).tickFormat(this._options.x.tickFormat)),"bar"==this._options.type&&this.g.append("g").attr("class","x axis").attr("transform",`translate(0, ${this.innerHeight+.5})`).attr("opacity","1").append("line").attr("stroke","currentColor").attr("x2",this.innerWidth),this._options.grid.x.show&&this.addXGrid()}addXLabel(){this.g.append("text").attr("class","xLabel axisLabel").attr("transform",`translate(${this.innerWidth/2},${this.height-this._margin.bottom/2})`).style("text-anchor","middle").text(this._options.x.label)}addX2(){this.x2=d3.scaleBand().domain(this._options._categories).rangeRound([-this.xWidth/2*this._options.style.barWidth,this.xWidth/2*this._options.style.barWidth])}addY(){this.yVar=this._options.y.name,this.y=d3[this._options.y.scale]().domain(this._options.y.domain?this._options.y.domain:this.extent(this._options.y.name,this._options.y.scale,"bar"==this._options.type)).range([this.innerHeight,0]),this._options.y.nice&&(this.y=this.y.nice()),this.g.append("g").attr("class","y axis").call(d3.axisLeft(this.y).tickFormat(this._options.y.tickFormat)),this._options.grid.y.show&&this.addYGrid(),this.y.domain()[0]<0&&"bar"==this._options.type&&this.g.append("g").attr("class","x axis").attr("transform",`translate(0, ${this.y(0)})`).attr("opacity","1").append("line").attr("stroke","currentColor").attr("x2",this.innerWidth)}addYGrid(){this.yNbTicks="scaleLog"==this._options.y.scale?Math.round(Math.log10(this.y.domain()[1])-Math.log10(this.y.domain()[0])):parseInt(this.innerHeight/40),this.yGrid=t=>t.call(d3.axisRight(this.y).ticks(this.yNbTicks).tickSize(this.innerWidth).tickFormat(this._options.y.tickFormat)).call(t=>t.selectAll(".domain").remove()).call(t=>t.selectAll(".tick:not(:first-of-type) line").attr("stroke-opacity",.5).attr("stroke-dasharray","2,2")).call(t=>t.selectAll(".tick:first-of-type line").remove()).call(t=>t.selectAll(".tick text").remove()).call(t=>t.selectAll(".tick line").attr("class","y-grid")),this.g.append("g").attr("class","yGrid").call(this.yGrid)}addXGrid(){this.xGrid=t=>t.call(d3.axisBottom(this.x).tickSize(this.innerHeight).ticks(this.xNbTicks).tickFormat(this._options.x.tickFormat)).call(t=>t.selectAll(".domain").remove()).call(t=>t.selectAll(".tick:not(:first-of-type) line").attr("stroke-opacity",.5).attr("stroke-dasharray","2,2")).call(t=>t.selectAll(".tick:first-of-type line").remove()).call(t=>t.selectAll(".tick text").remove()).call(t=>t.selectAll(".tick line").attr("class","x-grid")),this.g.append("g").attr("class","xGrid").call(this.xGrid)}addYGridLines(){for(const t of this._options.grid.y.lines)this.g.append("g").attr("class","y grid-line "+(t.class||"")).attr("transform",`translate(0, ${this.y(t.y)})`).attr("opacity","1").append("line").attr("class",""+(t.class||"")).attr("stroke","currentColor").attr("x2",this.innerWidth),t.label&&(t.textAnchor=t.textAnchor||t.position||"middle",t.xox=this.x(t.x)||(t.position?"middle"==t.position?this.innerWidth/2:"start"==t.position?this.margin.left:this.innerWidth-this.margin.right:this.margin.left),this.g.append("text").attr("y",this.y(t.y)).attr("x",t.xox).attr("dy","1em").attr("class","grid-line-label "+(t.class||"")).attr("style","font-size:0.8rem").style("text-anchor",t.textAnchor).text(t.label))}addXGridLines(){for(const t of this._options.grid.x.lines)this.g.append("g").attr("class","x grid-line "+(t.class||"")).attr("transform",`translate(${this.x(t.x)}, 0)`).attr("opacity","1").append("line").attr("class",""+(t.class||"")).attr("stroke","currentColor").attr("y2",this.innerHeight),t.label&&(t.textAnchor=t.textAnchor||t.position||"middle",t.yoy=this.y(t.y)||(t.position?"middle"==t.position?this.innerHeight/2:"start"==t.position?this.innerHeight-this.margin.top:this.margin.top:this.margin.top),this.g.append("text").attr("transform",`rotate(-90,${this.x(t.x)},${t.yoy})`).attr("y",t.yoy).attr("x",this.x(t.x)).attr("dy","1em").attr("class","grid-line-label "+(t.class||"")).attr("style","font-size:0.8rem").style("text-anchor",t.textAnchor).text(t.label))}addYLabel(){this.g.append("text").attr("transform","rotate(-90)").attr("y",0-this._margin.left).attr("x",0-this.innerHeight/2).attr("dy","1em").attr("class","yLabel axisLabel").style("text-anchor","middle").text(this._options.y.label)}_draw(){this.g.selectAll("path.lines").remove(),this.g.selectAll("rect.bar").remove(),this.g.selectAll("circle.dots").remove();for(const t of this._options._categories)["line","dotted-line"].indexOf(this._options.type)>-1&&this.g.append("path").datum(this.data.filter(i=>i[this._options.category.name]===t)).attr("class","lines").attr("fill","none").attr("stroke",i=>this.color(t)).attr("stroke-width",this._options.style.strokeWidth).attr("d",d3.line().y(t=>this.y(t[this._options.y.name])).defined(t=>t[this._options.y.name]).x(t=>this.x(t[this._options.x.name]))),"bar"==this._options.type&&this.g.selectAll("rect.bar."+t.replace(/[^a-z0-9A-Z]/g,"")).data(this.data.filter(i=>i[this._options.category.name]===t)).join("rect").attr("class","bar "+t.replace(/[^a-z0-9A-Z]/g,"")).attr("fill",i=>this.color(t)).attr("x",i=>this.x(i[this._options.x.name])+this.x2(t)).attr("width",this.x2.bandwidth()).attr("y",t=>t[this._options.y.name]>0?this.y(t[this._options.y.name]):this.y(0)).attr("height",t=>Math.abs((this.y(0)||this.y(this.y.domain()[0]))-this.y(t[this._options.y.name]))).on("mouseover",(function(t){d3.select(this).attr("fill",(function(){return d3.rgb(d3.select(this).style("fill")).darker(.5)}))})).on("mouseout",(function(t){d3.select(this).attr("fill",(function(){return d3.rgb(d3.select(this).style("fill")).brighter(.5)}))}));["dotted-line","dot"].indexOf(this._options.type)>-1&&this.g.selectAll("circle").data(this.data).join("circle").style("fill",t=>this.color(t[this._options.category.name])).attr("class","dots").attr("r",this._options.style.dotSize).attr("cx",(t,i)=>this.x(t[this._options.x.name])).attr("cy",(t,i)=>this.y(t[this._options.y.name]))}_buildTooltip(t,i,s,e){if(!i)return t.style("display","none");t.style("display",null);t.selectAll("line").data([null]).join("line").attr("class","tooltip_line").attr("style",`stroke: ${this._options.style.tooltipLineColor};`).attr("x1",s).attr("x2",s).attr("y1",0).attr("y2",this.innerHeight);if("bar"!=this._options.type){t.selectAll("circle").data(i.slice(1)).join("circle").style("fill",t=>this.isSparkline?this._options.sparkline["circle-color"]:this.color(t[this._options.category.name])).attr("r",this.isSparkline?2:5).attr("cx",(t,i)=>this.x(t[this._options.x.name])).attr("cy",(t,i)=>this.y(t[this._options.y.name]))}const o=t.selectAll("rect").data([null]).join("rect").attr("class","rect_tooltip").attr("style",`fill:${this._options.style.tooltipBackgroundColor}; fill-opacity: ${this._options.style.tooltipOpacity};`);let a;a=this.isSparkline?t.selectAll("text").data([null]).join("text").call(t=>t.selectAll("tspan").data(i.slice(1)).join("tspan").attr("x",0).attr("y",(t,i)=>1.1*i+"em").attr("class","tooltip_text").style("fill",(t,i)=>this._options.style.tooltipColor).text((t,i)=>""+this._options.y.tickFormat(t[this._options.y.name])).attr("style",`font-size:${this._options.sparkline.textFontSize};`)):t.selectAll("text").data([null]).join("text").call(t=>t.selectAll("tspan").data(i).join("tspan").attr("x",0).attr("y",(t,i)=>1.1*i+"em").attr("class","tooltip_text").style("font-weight","bold").style("fill",(t,i)=>0===i?"function"==typeof this._options.style.tooltipColor?this._options.style.tooltipColor():this._options.style.tooltipColor:this.color(t[this._options.category.name])).text((t,i)=>this._options.style.tooltipFormat(t,i)));const{xx:n,yy:r,width:l,height:h}=a.node().getBBox();let p=l+s+10>this.innerWidth?s-l-10:s+10,d=h+e-20>this.innerHeight?e-h:e;return a.attr("transform",`translate(${p},${d})`),o.attr("x",p-5).attr("y",d-20).attr("rx",5).attr("width",l+10).attr("height",h+10),!0}_getMouseData(t){let i=this.x.invert(t),s=d3.bisector(t=>t).left(this.xValues,i),e=s>0?this.xValues[s-1]:0,o=s>this.xValues.length-1?this.xValues.slice(-1)[0]:this.xValues[s],a=i-e>o-i?o:e,n=this.data.filter(t=>t[this._options.x.name].toString()==a.toString()).sort((t,i)=>i[this._options.y.name]-t[this._options.y.name]);return[a].concat(n)}addTooltip(){this.g.selectAll("g.tooltip_container").remove(),this.tooltip=this.g.append("g").attr("class","tooltip_container");let t=this;this.g.on("touchmove mousemove",(function(){let i=d3.mouse(this)[0],s=d3.mouse(this)[1];if(i>0){let e=t._getMouseData(i);t._buildTooltip(t.tooltip,e,t.x(e[0]),s+30)}})),this.g.on("touchend mouseleave",()=>{this.tooltip.call(this._buildTooltip,null)})}addLegend(){let t,i,s,e;this.g.selectAll(".legend").remove(),this.legend=this.g.append("g").attr("class","legend"),this.legendBackground=this.legend.selectAll("rect").data([null]).join("rect").attr("class","rect_legend").attr("style",`fill:${this._options.legend.backgroundColor}; fill-opacity: ${this._options.legend.opacity};`),this.legendDots=this.legend.selectAll(".dots-legend").data(this._options._categories),this.legendDots.exit().remove(),this.legendDots.enter().append("circle").merge(this.legendDots).attr("cx",this._options.legend.x+10).attr("cy",(t,i)=>this._options.legend.y+i*this._options.legend.interstice).attr("r",3).attr("class","dots-legend").style("fill",t=>this.color(t)),this.legendLabels=this.legend.selectAll(".labels-legend").data(this._options._categories),this.legendLabels.exit().remove(),this.legendLabels.enter().append("text").merge(this.legendLabels).attr("x",this._options.legend.x+30).attr("y",(t,i)=>this._options.legend.y+i*this._options.legend.interstice).style("fill",t=>this.color(t)).text(t=>this._options.category.parse(t)).attr("text-anchor","left").style("alignment-baseline","middle").attr("class","labels-legend");try{let o=this.legend.node().getBBox();t=o.x,i=o.y,s=o.width,e=o.height}catch(o){t=85,i=5,s=0,e=0}this.legendBackground.attr("x",this._options.legend.x-5).attr("y",this._options.legend.y-10).attr("width",s>0?s+20:10*d3.max(this._options._categories.map(t=>t.length))+10).attr("height",e>0?e+10:this._options._categories.length*this._options.legend.interstice+10)}}
